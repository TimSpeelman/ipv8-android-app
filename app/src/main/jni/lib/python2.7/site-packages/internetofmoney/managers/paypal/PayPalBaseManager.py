import base64
import hashlib
import json
from urllib import quote_plus

from internetofmoney.managers.BaseManager import BaseManager


class PayPalBaseManager(BaseManager):

    def __init__(self, database, cache_dir='cache'):
        super(PayPalBaseManager, self).__init__(database, cache_dir=cache_dir)
        self.persistent_storage['registered'] = True  # No registration required, one can immediately login
        self.logged_in = False
        self.access_token = None
        self.guid = "FB04564F-6675-454A-972E-9A50A5D75A8B"

        # Keep a cache with the descriptions that we've already seen for each transaction. This saves requests.
        self.known_descriptions = {}

    def is_logged_in(self):
        return self.logged_in

    def persistent_storage_filename(self):
        return 'paypal_account.json'

    def get_bank_name(self):
        return 'PayPal'

    def get_bank_id(self):
        return 'PP'

    def is_switch_capable(self):
        """
        Currently, PayPal is not capable of being a money switch.
        """
        return False

    def generate_auth_nonce(self, timestamp, email, password):
        data = "com.yourcompany.PPClient" + self.guid + self.guid + email + password[:3] + str(timestamp)
        sha_mod = hashlib.sha256()
        sha_mod.update(data)
        return base64.encodestring(sha_mod.digest()).rstrip('\n')

    def get_paypal_headers(self, is_json=False):
        if self.logged_in:
            auth_header = 'Bearer %s' % self.access_token
        else:
            auth_header = 'Basic QVY4aGRCQk04MHhsZ0tzRC1PYU9ReGVlSFhKbFpsYUN2WFdnVnB2VXFaTVRkVFh5OXBtZkVYdEUxbENxOg=='

        if is_json:
            content_type = 'application/json'
        else:
            content_type = 'application/x-www-form-urlencoded'

        app_context = {
            "deviceLocationCountry": "Unknown",
            "deviceOS": "iPhone OS",
            "appName": "com.yourcompany.PPClient",
            "sdkVersion": "1.0.0",
            "appGuid": self.guid,
            "appVersion": "6.11.0",
            "deviceLocale": "nl_NL",
            "deviceNetworkType": "Unknown",
            "deviceOSVersion": "8.1.2",
            "deviceLanguage": "nl",
            "deviceType": "iPhone",
            "deviceMake": "Apple",
            "deviceModel": "iPhone",
            "deviceNetworkCarrier": "Unknown"
        }

        return {
            'Accept-Language': 'nl-nl',
            'Accept': '*/*',
            'Connection': 'keep-alive',
            'Content-Type': content_type,
            'User-Agent': 'PayPal/116 (iPhone; iOS 8.1.2; Scale/2.00)',
            'X-PayPal-ConsumerApp-Context': quote_plus(json.dumps(app_context)),
            'Authorization': auth_header,
        }
